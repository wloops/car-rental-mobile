<!-- 车型选择页面 -->
<template>
  <div class="SelectModel">
    <div class="top-navBar" id="navBar">
      <model-navtop></model-navtop>
    </div>
    <div class="imgLinkAD">
      <swipe-ad :ad-images-link="adImagesLink"></swipe-ad>
    </div>
    <div class="treeSelect">
      <van-tree-select
        :height="treeHeight"
        :items="itemsTree"
        :main-active-index.sync="active"
        @click-nav="handleClickNav"
      >
        <template #content>
          <van-pull-refresh
            success-text="刷新成功"
            v-model="refreshing"
            @refresh="onRefresh"
          >
            <van-list
              v-model="loading"
              :finished="finished"
              offset="50"
              finished-text="没有更多了"
              @load="onLoad"
              ref="checkList"
            >
              <!-- <van-skeleton :row="10" :loading="skeletonLoading"> -->
              <van-grid :column-num="1" :gutter="15" clickable :border="false">
                <van-grid-item
                  v-for="(item, index) in carInfo"
                  :key="index"
                  icon="photo-o"
                  @click="selectCarItem(item)"
                >
                  <template>
                    <div class="carCard">
                      <div class="carImg">
                        <van-image
                          width="5rem"
                          height="5rem"
                          fit="contain"
                          :src="item.carImg"
                        />
                      </div>
                      <div class="carInfo">
                        <div class="carName">{{ item.carModelShowName }}</div>
                        <div class="carMsg van-ellipsis">
                          {{ item.carDescription }}
                        </div>
                        <div class="carPrice">
                          ￥{{ item.carPrice }} <span>日均</span>
                        </div>
                      </div>
                    </div>
                  </template>
                </van-grid-item>
              </van-grid>
              <!-- </van-skeleton> -->
            </van-list>
          </van-pull-refresh>
        </template>
      </van-tree-select>
    </div>
    <!-- 车辆详情 -->
    <div class="carDetails">
      <car-details ref="showCarDetails"></car-details>
    </div>
  </div>
</template>

<script>
import ModelNavtop from './components/ModelNavtop.vue'
import SwipeAd from '@/views/home/components/SwipeAd.vue'
import CarDetails from '@/components/CarDetails.vue'

import { BASE_DOMAIN } from '@/global/config'

import { getVehicleType, getVehicleOfType } from '@/api/carInfo'

export default {
  name: 'SelectModel',
  components: {
    ModelNavtop,
    SwipeAd,
    CarDetails,
  },
  props: {},
  data() {
    return {
      active: 0,
      itemsTree: [],
      classifyName: '',
      checked: false,
      loading: false,
      finished: false,
      refreshing: false,
      carInfoList: [],
      total: 0, //总共的数据条数
      // skeletonLoading: true,
      currentCarInfo: [],
      currentPage: 0,
      numOfPerPage: 10,
    }
  },
  computed: {
    adImagesLink() {
      // 广告图片链接 vuex
      return this.$store.getters.getAdImagesLink
    },
    carInfo() {
      // 车辆信息 vuex
      return this.$store.getters['car/getCarInfo']
    },
    startDate() {
      // 开始时间 vuex
      // 格式化时间为 yyyyMMdd
      let startDate = this.$store.getters['time/getStartDate']
      if (startDate != null) {
        startDate = startDate.replace(/-/g, '')
      }
      return startDate
    },
    endDate() {
      // 结束时间 vuex
      // 格式化时间为 yyyyMMdd
      let endDate = this.$store.getters['time/getEndDate']
      if (endDate != null) {
        endDate = endDate.replace(/-/g, '')
      }
      return endDate
    },
    rentalDays() {
      return this.$store.getters['time/getDayToDay']
    },
  },
  watch: {
    startDate: {
      handler(newValue, oldValue) {
        // this.setStartDate(newValue)
        // 值改变触发loadVehicleOfType请求
        if (oldValue != newValue) {
          // this.loadVehicleOfType()
          this.onRefresh()
        }
      },
      // immediate: true, // 初始化时立即触发
    },
    endDate: {
      handler(newValue, oldValue) {
        // this.setEndDate(newValue)
        // 值改变触发loadVehicleOfType请求
        if (oldValue != newValue) {
          // this.loadVehicleOfType()
          this.onRefresh()
        }
      },
      // immediate: true, // 初始化时立即触发
    },
    $route(to, from) {
      console.log('$route', to, from)
      if (from.path === '/') {
        this.onRefresh()
      }
    },
  },
  created() {
    // 获取车型分类
    getVehicleType().then(res => {
      if (res.data.rs !== '1') {
        console.log('res.data.queryVehicleType', res.data.queryVehicleType)
        console.log('获取车型分类失败')
        return false
      }
      this.itemsTree = res.data.queryVehicleType.map(item => {
        return {
          // id: item.id,
          text: item.displayName,
          classifyName: item.classifyName,
          actNo: item.actNo,
        }
      })
      this.$store.commit('car/setActNo', this.itemsTree[this.active].actNo)
      // this.loadVehicleOfType()
    })
  },
  mounted() {
    // 计算高度
    console.log('可视高度', window.screen.availHeight)
    // let navBarH = document.getElementById('navBar').offsetHeight
    let imgLinkH = document.getElementsByClassName('imgLinkAD')[0].offsetHeight
    this.treeHeight = window.screen.availHeight - imgLinkH - 100
    // console.log('navBarH', navBarH)
    console.log('imgLinkH', imgLinkH)
    console.log('treeHeight', this.treeHeight)
  },
  methods: {
    selectCarItem(e) {
      // 当前选择车辆
      // let imgURL =
      //   e.currentTarget.children[0].children[0].children[0].children[0].src
      // console.log('imgURL', imgURL)
      let prdNo = e.prdNo
      this.carInfo.forEach((item, index) => {
        if (item.prdNo === prdNo) {
          this.$store.commit('car/setCurrentCarInfo', item)
        }
      })
      this.$refs.showCarDetails.showPopup()
    },
    toConfirmOrder() {
      this.$router.push('/confirm')
    },
    // 获取车辆信息
    loadVehicleOfType() {
      getVehicleOfType({
        classifyName: this.itemsTree[this.active].classifyName,
        actNo: this.itemsTree[this.active].actNo,
        startTime: this.startDate,
        endTime: this.endDate,
        rentalDays: this.rentalDays,
        currentPage: this.currentPage,
        numOfPerPage: this.numOfPerPage,
      }).then(res => {
        if (res.data.rs !== '1') {
          return false
        }
        let carInfos = res.data.queryVehicleOfType
        console.log(carInfos)
        // 拼接车辆图片信息
        this.carInfoList = carInfos.map(item => {
          if (item.carImg) {
            item.carImg = `${BASE_DOMAIN}/socketServer/images/cardMall/imgsrc/${item.carImg}`
          }
          if (item.carPrice) {
            item.carPrice = item.carPrice
          }
          return item
        })
        this.total = res.data.queryVehicleOfType_totalRecNum

        // this.loading = true
        // this.carInfoList.forEach((item, index) => {
        //   this.currentCarInfo.push(item)
        // })
        // this.currentCarInfo.push(...this.carInfoList)
        this.currentCarInfo = this.currentCarInfo.concat(this.carInfoList)

        let currentCarInfoNew = []
        // currentCarInfo每一项的classifyName都相等时，才能渲染
        this.currentCarInfo.forEach((item, index) => {
          if (item.classifyName === this.itemsTree[this.active].classifyName) {
            currentCarInfoNew.push(item)
          }
        })

        // this.$store.commit('car/setCarInfo', this.currentCarInfo)
        this.$store.commit('car/setCarInfo', currentCarInfoNew)
        console.log('carInfo:', this.carInfo)

        if (this.carInfo.length >= parseInt(this.total)) {
          this.finished = true
        }

        this.loading = false
        // this.skeletonLoading = false
        this.finished = this.currentCarInfo.length >= this.total
      })
    },
    handleClickNav(index) {
      this.active = index
      // this.currentPage = 0
      // this.currentCarInfo = []
      // this.loading = true
      // this.finished = false
      this.$store.commit('car/setCarInfo', [])
      this.onRefresh()
    },
    //加载时触发
    onLoad() {
      setTimeout(() => {
        this.currentPage++
        console.log('onLoad')
        // this.skeletonLoading = true

        if (this.refreshing) {
          this.refreshing = false
        }

        // if (this.itemsTree.length === 0) {
        // // 获取车型分类
        // getVehicleType().then(res => {
        //   console.log('res.data.queryVehicleType', res.data.queryVehicleType)
        //   if (res.data.queryVehicleType === undefined) {
        //     console.log('获取车型分类失败')
        //     return false
        //   }
        //   this.itemsTree = res.data.queryVehicleType.map(item => {
        //     return {
        //       // id: item.id,
        //       text: item.displayName,
        //       classifyName: item.classifyName,
        //       actNo: item.actNo,
        //     }
        //   })
        //   this.$store.commit(
        //     'car/setActNo',
        //     this.itemsTree[this.active].actNo
        //   )
        //   this.loadVehicleOfType()
        // })
        // } else {
        this.loadVehicleOfType()
        // }

        // this.loading = false
        // if (this.carInfo.length >= this.total) {
        //   this.finished = true
        // }
      }, 1000)
    },
    onRefresh() {
      console.log('onRefresh')
      this.currentPage = 0
      // 清空列表数据
      this.currentCarInfo = []
      this.finished = false

      // 重新加载数据
      // 将 loading 设置为 true，表示处于加载状态
      this.loading = true
      this.onLoad()
    },
  },
}
</script>

<style scoped lang="less">
// /deep/ .van-grid-item__content--center {
//   border: 1px solid #ededed;

//   position: relative;
// }
.SelectModel {
  height: 100%;
}
.treeSelect {
  .van-list {
    margin-top: 0.5rem;
  }
  /deep/ .van-grid-item__content {
    border-radius: 5px;
    box-shadow: 1px 1px 8px #ccc;
  }
}
// .checkbox {
//   position: absolute;
//   right: 5px;
//   top: 5px;
//   z-index: 100;
// }
.text {
  line-height: 0.2rem;
}

.carCard {
  display: flex;
  justify-content: space-around;
  align-items: center;
  width: 100%;
  padding-left: 1rem;

  .carName {
    font-size: 1rem;
    font-weight: 600;
    margin: 0.5rem;
    color: rgb(75, 72, 72);
  }
  .carMsg {
    margin: 0.5rem;
    width: 8rem;
    font-size: smaller;
  }
  .carPrice {
    font-size: 1rem;
    font-weight: 600;
    margin: 0.5rem;
    color: #ffba1c;
    span {
      font-size: x-small;
      color: rgb(168, 164, 164);
    }
  }
}
/deep/ .van-grid-item__content {
  padding: 0;
}
</style>
